<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Informe de Gestión - Inteligencia de Negocios</title>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11pt;
        }
        h1, h2, h3 {
            margin: 0;
            padding: 0;
        }
        .header {
            text-align: center;
            margin-bottom: 16px;
        }
        .subheader {
            font-size: 10pt;
            margin-bottom: 12px;
        }
        .section {
            margin-top: 14px;
            margin-bottom: 10px;
        }
        .section h2 {
            font-size: 12pt;
            margin-bottom: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 4px;
            margin-bottom: 6px;
        }
        th, td {
            border: 1px solid #999;
            padding: 3px 4px;
            font-size: 9pt;
        }
        th {
            background-color: #f0f0f0;
        }
        .small {
            font-size: 9pt;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Informe de Gestión - Inteligencia de Negocios</h1>
    <h3>Junta de Vecinos "Villa Vista al Mar"</h3>
</div>

<div class="subheader">
    <p class="small">
        <strong>Generado por:</strong> {{ usuario }}<br>
        <strong>Fecha:</strong> {{ fecha_generacion|date:"d/m/Y H:i" }}<br>

        <strong>Total Vecinos Registrados:</strong>
        {% if participacion %}
            {{ participacion.total_vecinos }}
        {% else %}
            0
        {% endif %}<br>

        <strong>Vecinos Participantes (Votaciones):</strong>
        {% if participacion %}
            {{ participacion.total_participantes }}
        {% else %}
            0
        {% endif %}<br>

        <strong>Tasa de Participación Global:</strong>
        {% if participacion %}
            {{ participacion.porcentaje_actual|floatformat:1 }} %
        {% else %}
            0.0 %
        {% endif %}<br>

        <!-- KPIs técnicos (tarjetas del panel BI) -->
        <strong>Disponibilidad del Sistema:</strong>
        {% if metricas %}
            {{ metricas.disponibilidad_sistema|floatformat:1 }} %
        {% else %}
            -
        {% endif %}<br>

        <strong>Fallos en Votaciones:</strong>
        {% if metricas %}
            {{ metricas.fallos_votacion }}
        {% else %}
            0
        {% endif %}<br>

        <strong>Precisión Promedio de Transcripciones:</strong>
        {{ precision|default:"0"|floatformat:1 }} %<br>

        <strong>Tiempo Promedio de Respuesta:</strong>
        {% if tiempo_segundos %}
            {{ tiempo_segundos|floatformat:2 }} s
        {% else %}
            -
        {% endif %}
    </p>
</div>

<hr>

<!-- 1. Distribución Demográfica (Por Sector) -->
<div class="section">
    <h2>1. Distribución Demográfica (Por Sector)</h2>

    {% if demografia_sector %}
        <table>
            <thead>
                <tr>
                    <th>Sector / Dirección</th>
                    <th>Cantidad de Vecinos</th>
                </tr>
            </thead>
            <tbody>
                {% for d in demografia_sector %}
                    <tr>
                        <td>{{ d.direccion_sector }}</td>
                        <td>{{ d.total_vecinos }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay datos disponibles.</p>
    {% endif %}
</div>

<!-- 2. Ocupación de Talleres -->
<div class="section">
    <h2>2. Ocupación de Talleres</h2>

    {% if ocupacion_talleres %}
        <table>
            <thead>
                <tr>
                    <th>Nombre del Taller</th>
                    <th>Inscritos</th>
                    <th>Cupos Totales</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for t in ocupacion_talleres %}
                    <tr>
                        <td>{{ t.nombre }}</td>
                        <td>{{ t.inscritos }}</td>
                        <td>{{ t.cupos }}</td>
                        <td>
                            {% if t.cupos|default:0 > 0 and t.inscritos >= t.cupos %}
                                Completo
                            {% elif t.inscritos > 0 %}
                                Con cupos disponibles
                            {% else %}
                                Sin inscritos
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay talleres registrados.</p>
    {% endif %}
</div>

<!-- 3. Transparencia: Actas Más Consultadas -->
<div class="section">
    <h2>3. Transparencia: Actas Más Consultadas</h2>

    {% if consulta_actas %}
        <table>
            <thead>
                <tr>
                    <th>Título del Acta</th>
                    <th>Fecha Reunión</th>
                    <th>Total Consultas</th>
                </tr>
            </thead>
            <tbody>
                {% for a in consulta_actas %}
                    <tr>
                        <td>{{ a.acta__titulo }}</td>
                        <!-- Si no tienes fecha en el queryset, se deja "-" -->
                        <td>-</td>
                        <td>{{ a.consultas }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No se han registrado consultas aún.</p>
    {% endif %}
</div>

<!-- 4. Asistencia a Reuniones (Serie de Tiempo) -->
<div class="section">
    <h2>4. Asistencia a Reuniones (Evolución)</h2>

    {% if data_asistencia %}
        <table>
            <thead>
                <tr>
                    <th>Fecha de la Reunión</th>
                    <th>Nombre de la Reunión</th>
                    <th>Total Asistentes</th>
                </tr>
            </thead>
            <tbody>
                {% for a in data_asistencia %}
                    <tr>
                        <td>{{ a.fecha }}</td>
                        <td>{{ a.titulo }}</td>
                        <td>{{ a.total }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay registros de asistencia en el período analizado.</p>
    {% endif %}
</div>

<!-- 5. Precisión de Transcripciones (Detalle) -->
<div class="section">
    <h2>5. Precisión de Transcripciones</h2>

    {% if detalle_precision %}
        <p class="small">
            La siguiente tabla resume la precisión evaluada para cada acta,
            similar al detalle mostrado en el panel BI.
        </p>
        <table>
            <thead>
                <tr>
                    <th>Reunión / Acta</th>
                    <th>Fecha</th>
                    <th>Precisión (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for acta in detalle_precision %}
                    <tr>
                        <td>{{ acta.titulo }}</td>
                        <td>{{ acta.fecha_reunion|date:"d/m/Y" }}</td>
                        <td>{{ acta.precision_transcripcion|floatformat:0 }}%</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay actas con calificación de precisión registrada.</p>
    {% endif %}
</div>

<!-- 6. Rendimiento y Disponibilidad del Sistema -->
<div class="section">
    <h2>6. Rendimiento y Disponibilidad del Sistema</h2>

    <!-- 6.1 Historial de velocidad de respuesta -->
    <h3>6.1 Historial de Velocidad (Últimas 50 peticiones)</h3>
    {% if detalle_rendimiento %}
        <table>
            <thead>
                <tr>
                    <th>Página</th>
                    <th>Usuario</th>
                    <th>Tiempo (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for log in detalle_rendimiento %}
                    <tr>
                        <td>{{ log.path }}</td>
                        <td>{{ log.usuario }}</td>
                        <td>{{ log.tiempo_s }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay registros de rendimiento disponibles.</p>
    {% endif %}

    <!-- 6.2 Disponibilidad por ruta -->
    <h3>6.2 Disponibilidad por Ruta (Últimas 50 peticiones)</h3>
    {% if detalle_disponibilidad %}
        <table>
            <thead>
                <tr>
                    <th>Fecha / Hora</th>
                    <th>Ruta</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for log in detalle_disponibilidad %}
                    <tr>
                        <td>{{ log.fecha|date:"d/m/Y H:i:s" }}</td>
                        <td>{{ log.path }}</td>
                        <td>
                            {% if log.es_error %}
                                ERROR {{ log.status }}
                            {% else %}
                                OK {{ log.status }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="small">No hay historial de disponibilidad registrado.</p>
    {% endif %}
</div>

</body>
</html>
