{% extends 'base.html' %}
{% load can %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">{{ titulo }}</h1>
    <a href="{% url 'recursos:lista_recursos' %}" class="btn btn-outline-secondary">
        ← Volver a Gestión de Recursos
    </a>
</div>

<ul class="nav nav-tabs mb-3">
    {% for estado_val, estado_label in estados_posibles %}
      {# Solo mostramos las pestañas relevantes para la gestión #}
      {% if estado_val == 'PENDIENTE' or estado_val == 'APROBADA' or estado_val == 'RECHAZADA' %}
      <li class="nav-item">
          <a class="nav-link {% if filtro_actual == estado_val %}active{% endif %}" 
             href="{% url 'recursos:gestionar_reservas' %}?estado={{ estado_val }}">
             {{ estado_label }}
             
             {# Añadimos una insignia de conteo solo a PENDIENTE #}
             {% if estado_val == 'PENDIENTE' and conteo_pendientes > 0 %}
               <span class="badge bg-danger rounded-pill ms-1">{{ conteo_pendientes }}</span>
             {% endif %}
          </a>
      </li>
      {% endif %}
    {% endfor %}
</ul>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Vecino</th>
                        <th>Recurso</th>
                        <th>Fechas Solicitadas</th>
                        <th>Motivo</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reserva in reservas %}
                    <tr>
                        <td class="text-nowrap">
                            <strong>{{ reserva.vecino.username }}</strong>
                            <span class="d-block small text-muted">{{ reserva.vecino.perfil.rut|default:"-" }}</span>
                        </td>
                        <td>{{ reserva.recurso.nombre }}</td>
                        <td class="text-nowrap">
                            {{ reserva.fecha_inicio|date:"d/m/Y H:i" }}
                            <span class="d-block small text-muted">hasta {{ reserva.fecha_fin|date:"d/m/Y H:i" }}</span>
                        </td>
                        <td class="small" style="min-width: 200px;">{{ reserva.motivo|linebreaksbr }}</td>
                        
                        <td class="text-end text-nowrap">
                            {% if reserva.estado == 'PENDIENTE' %}
                            <form action="{% url 'recursos:actualizar_estado_reserva' reserva.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                <button type="submit" name="accion" value="APROBADA" class="btn btn-sm btn-success">
                                  Aprobar
                                </button>
                                <button type="submit" name="accion" value="RECHAZADA" class="btn btn-sm btn-outline-danger ms-1">
                                  Rechazar
                                </button>
                            </form>
                            {% else %}
                                <span class="badge {% if reserva.estado == 'APROBADA' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ reserva.get_estado_display }}
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">No hay solicitudes en estado "{{ filtro_actual }}".</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}