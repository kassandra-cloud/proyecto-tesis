{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">{{ titulo }}</h1>
  <a href="{% url 'crear_usuario' %}" class="btn btn-dark">+ Nuevo</a>
</div>

<form method="get" class="row g-2 align-items-center mb-3">
  <div class="col">
    <input class="form-control" name="q" value="{{ q }}" placeholder="Buscar por username, email, nombre, RUT">
  </div>
  <div class="col-auto">
    <select class="form-select" name="per_page" onchange="this.form.submit()">
      {% for n in opciones_per_page %}
        <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }} registros</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-primary">Buscar</button>
  </div>
</form>

{# ===== CARD 1: USUARIOS ACTIVOS ===== #}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-semibold">Usuarios activos</span>
    <span class="badge text-bg-secondary">{{ paginator.count }} activos</span>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-nowrap">
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=username&dir={% if sort == 'username' %}{{ next_dir }}{% else %}asc{% endif %}">
                Username{% if sort == 'username' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th class="text-nowrap">
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=email&dir={% if sort == 'email' %}{{ next_dir }}{% else %}asc{% endif %}">
                Email{% if sort == 'email' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=nombre&dir={% if sort == 'nombre' %}{{ next_dir }}{% else %}asc{% endif %}">
                Nombre{% if sort == 'nombre' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=apellido_paterno&dir={% if sort == 'apellido_paterno' %}{{ next_dir }}{% else %}asc{% endif %}">
                Apellido Paterno{% if sort == 'apellido_paterno' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=apellido_materno&dir={% if sort == 'apellido_materno' %}{{ next_dir }}{% else %}asc{% endif %}">
                Apellido Materno{% if sort == 'apellido_materno' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th class="text-nowrap">
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=rut&dir={% if sort == 'rut' %}{{ next_dir }}{% else %}asc{% endif %}">
                RUT{% if sort == 'rut' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>
            <th>
              <a class="text-decoration-none" href="?q={{ q }}&per_page={{ per_page }}&sort=rol&dir={% if sort == 'rol' %}{{ next_dir }}{% else %}asc{% endif %}">
                Rol{% if sort == 'rol' %}{% if dir == 'asc' %} ▲{% else %} ▼{% endif %}{% endif %}
              </a>
            </th>

            {# Columna de acciones con ancho fijo #}
            <th class="text-end text-nowrap" style="width:260px;">Acciones</th>
          </tr>
        </thead>

        <tbody>
        {% for u in page_obj %}
          <tr>
            <td class="text-nowrap">{{ u.username }}</td>
            <td class="text-truncate" style="max-width:220px">{{ u.email|default:"-" }}</td>
            <td>{{ u.first_name|default:"-" }}</td>
            <td>{{ u.perfil.apellido_paterno|default:"-" }}</td>
            <td>{{ u.perfil.apellido_materno|default:"-" }}</td>
            <td class="text-nowrap">{{ u.perfil.rut|default:"-" }}</td>
            <td class="text-capitalize">{{ u.perfil.rol|default:"-" }}</td>

            <td class="text-end text-nowrap" style="width:260px;">
              <div class="row g-2 justify-content-end" style="min-width:240px;">
                <div class="col-6 d-grid">
                  <a href="{% url 'editar_usuario' u.pk %}" class="btn btn-sm btn-outline-secondary w-100">Editar</a>
                </div>
                <div class="col-6 d-grid">
                  {% if request.user.pk != u.pk and not u.is_superuser %}
                    <form action="{% url 'deshabilitar' u.pk %}" method="post" class="m-0 w-100">
                      {% csrf_token %}
                      <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                              onclick="event.preventDefault(); const form = this.closest('form'); 
                                      Swal.fire({
                                        title: '¿Deshabilitar a {{ u.username }}?',
                                        text: 'El usuario no podrá iniciar sesión.',
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#d33',
                                        cancelButtonColor: '#6c757d',
                                        confirmButtonText: 'Sí, deshabilitar',
                                        cancelButtonText: 'Cancelar'
                                      }).then((result) => {
                                        if (result.isConfirmed) {
                                          form.submit();
                                        }
                                      })">
                        Deshabilitar
                      </button>
                    </form>
                  {% else %}
                    <span class="btn btn-sm btn-outline-secondary w-100 disabled">Protegido</span>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8" class="text-center text-muted">No hay usuarios activos.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if paginator.num_pages > 1 %}
      <div class="p-3 border-top">
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_previous %}?q={{ q }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}&sort={{ sort }}&dir={{ dir }}{% else %}#{% endif %}">Anterior</a>
            </li>
            <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ paginator.num_pages }}</span></li>
            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_next %}?q={{ q }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}&sort={{ sort }}&dir={{ dir }}{% else %}#{% endif %}">Siguiente</a>
            </li>
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</div>

{# ===== CARD 2: USUARIOS DESHABILITADOS ===== #}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-semibold">Usuarios deshabilitados (Historial)</span>
    <span class="badge text-bg-secondary">{{ usuarios_inactivos|length }}</span>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Nombre</th>
            <th>RUT</th>
            <th>Rol</th>
            <th class="text-end text-nowrap" style="width:260px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for u in usuarios_inactivos %}
          <tr>
            <td class="text-nowrap">{{ u.username }}</td>
            <td class="text-truncate" style="max-width:220px">{{ u.email|default:"-" }}</td>
            <td>{{ u.get_full_name|default:"-" }}</td>
            <td class="text-nowrap">{{ u.perfil.rut|default:"-" }}</td>
            <td class="text-capitalize">{{ u.perfil.rol|default:"-" }}</td>

            <td class="text-end text-nowrap" style="width:260px;">
              <div class="row g-2 justify-content-end" style="min-width:240px;">
                <div class="col-6 d-grid">
                  {# placeholder para alinear con 'Editar' de la tabla superior #}
                  <span class="btn btn-sm w-100 invisible">Editar</span>
                </div>
                <div class="col-6 d-grid">
                  <form action="{% url 'restaurar' u.pk %}" method="post" class="m-0 w-100">
                    {% csrf_token %}
                    <button type="button" class="btn btn-sm btn-success w-100"
                            onclick="event.preventDefault(); const form = this.closest('form');
                                    Swal.fire({
                                      title: '¿Restaurar a {{ u.username }}?',
                                      text: 'El usuario podrá volver a iniciar sesión.',
                                      icon: 'question',
                                      showCancelButton: true,
                                      confirmButtonColor: '#198754',
                                      cancelButtonColor: '#6c757d',
                                      confirmButtonText: 'Sí, restaurar',
                                      cancelButtonText: 'Cancelar'
                                    }).then((result) => {
                                      if (result.isConfirmed) {
                                        form.submit();
                                      }
                                    })">
                      Restaurar
                    </button>
                  </form>
                </div>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-center text-muted">No hay usuarios deshabilitados.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
