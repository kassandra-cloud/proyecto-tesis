{% extends "base_public.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Configurar Contraseña{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center p-4" style="min-height: 100vh; background-color: #f0f2f5;">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden" style="max-width: 900px; width: 100%;">
        <div class="row g-0">
            
            <div class="col-md-5 d-none d-md-flex flex-column justify-content-center align-items-center text-white p-4" 
                 style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                <div class="mb-4">
                   <img src="{% static 'img/logo3.png' %}" alt="Logo" style="width: 120px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));">
                </div>
                <h3 class="fw-bold mb-3">Seguridad</h3>
                <p class="text-center opacity-75">
                    Es tu primer inicio de sesión. Por seguridad, debes actualizar tu contraseña temporal por una personal.
                </p>
            </div>

            <div class="col-md-7 p-5">
                
                <div class="text-center mb-4">
                    <h2 class="h4 fw-bold text-dark">Crear Contraseña</h2>
                    <p class="text-muted small">Configura tu acceso definitivo.</p>
                </div>

                {% if form.errors %}
                    <div class="alert alert-danger fade show" role="alert">
                        <ul class="mb-0 ps-3 small">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">CONTRASEÑA ACTUAL</label>
                        <div class="input-group">
                            <input type="password" name="old_password" id="id_old_password" 
                                   class="form-control" placeholder="La que recibiste por correo" required>
                            
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="toggleDirect('id_old_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">NUEVA CONTRASEÑA</label>
                        <div class="input-group">
                            <input type="password" name="new_password1" id="id_password1" 
                                   class="form-control" placeholder="******" required>
                            
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="toggleDirect('id_password1', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label fw-bold small text-muted">CONFIRMAR NUEVA</label>
                        <div class="input-group">
                            <input type="password" name="new_password2" id="id_password2" 
                                   class="form-control" placeholder="******" required>
                            
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="toggleDirect('id_password2', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card bg-light border-0 mb-4 small rounded-3">
                        <div class="card-body p-3">
                            <div id="pw-match" class="mb-2 fw-bold text-danger">
                                ✖ Las contraseñas no coinciden.
                            </div>
                            <hr class="my-1">
                            <ul class="list-unstyled mb-0 mt-2 text-muted">
                                <li id="pm-create-len" class="text-danger mb-1">
                                    <span class="pm-icon">✖</span> Mínimo 14 caracteres
                                </li>
                                <li id="pm-create-lower" class="text-danger mb-1">
                                    <span class="pm-icon">✖</span> Al menos una minúscula
                                </li>
                                <li id="pm-create-upper" class="text-danger mb-1">
                                    <span class="pm-icon">✖</span> Al menos una mayúscula
                                </li>
                                <li id="pm-create-sym" class="text-danger">
                                    <span class="pm-icon">✖</span> Un símbolo o número
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" id="btn-guardar" class="btn btn-primary btn-lg fw-bold shadow-sm" disabled>
                            Actualizar Contraseña
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <button type="submit" form="logout-form" class="btn btn-link text-decoration-none text-muted small">
                            Cancelar y salir
                        </button>
                    </div>
                </form>

                <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                    {% csrf_token %}
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    function toggleDirect(fieldId, btnElement) {
        var input = document.getElementById(fieldId);
        var icon = btnElement.querySelector('i');

        if (input) {
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                btnElement.classList.add('text-primary');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                btnElement.classList.remove('text-primary');
            }
        }
    }
</script>

<script src="{% static 'js/password-meter.js' %}"></script>

{% endblock %}