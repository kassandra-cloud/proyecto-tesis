{% extends "base.html" %}
{% load can %}

{% block title %}Detalle de Reuni√≥n{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header">
    <h1 class="h4 mb-0">{{ reunion.titulo }}</h1>
  </div>

  <div class="card-body">
    <p><strong>Tipo:</strong> {{ reunion.tipo }}</p>
    <p><strong>Fecha y Hora:</strong> {{ reunion.fecha|date:"d/m/Y H:i" }} hrs</p>

    <h5 class="mt-4">Tabla de Contenidos (Temas a tratar)</h5>
    <div class="p-3 bg-light rounded border">
      {{ reunion.tabla|linebreaks }}
    </div>

    {% user_can 'actas' 'edit' as puede_editar_acta %}
    <h5 class="mt-4">Contenido del Acta (Previsualizaci√≥n)</h5>

    {% if puede_editar_acta %}
      <!-- Controles de Transcripci√≥n -->
      <div class="d-flex align-items-center gap-2 mb-2">
        <button id="btnStartSTT" class="btn btn-danger">üéôÔ∏è Iniciar Transcripci√≥n</button>
        <button id="btnStopSTT"  class="btn btn-outline-secondary" disabled>‚èπÔ∏è Detener</button>
        <span id="sttStatus" class="text-muted">Micr√≥fono inactivo</span>
      </div>
      <div class="form-text mb-2">
        <strong>Parcial:</strong> <span id="sttPartial" style="opacity:.8"></span>
      </div>

      <!-- Textarea: prioriza BORRADOR; si no hay, usa contenido del acta -->
      <textarea id="contenido_acta" class="form-control" rows="12"
        placeholder="Aqu√≠ aparecer√° la transcripci√≥n en vivo y puedes editar antes de guardar.">{% if reunion.acta %}{% if reunion.acta.transcripcion_borrador %}{{ reunion.acta.transcripcion_borrador }}{% else %}{{ reunion.acta.contenido }}{% endif %}{% endif %}</textarea>

      <!-- BOTONES: Guardar + Limpiar -->
      <div class="d-flex align-items-center gap-2 mt-2">
        <button id="btnGuardarSolo" class="btn btn-success">Guardar</button>
        <button id="btnLimpiar" class="btn btn-outline-danger">Limpiar</button>
        <span id="saveStatus" class="text-muted small ms-2"></span>
      </div>

    {% else %}
      {% if reunion.acta and reunion.acta.contenido %}
        <div class="p-3 bg-white rounded border" style="white-space: pre-wrap;">
          {{ reunion.acta.contenido|linebreaks }}
        </div>
      {% else %}
        <div class="alert alert-info">A√∫n no se ha redactado el acta para esta reuni√≥n.</div>
      {% endif %}
    {% endif %}

    <hr>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'reuniones:lista_reuniones' %}" class="btn btn-secondary">‚Üê Volver a la lista</a>

      {% user_can 'reuniones' 'asistencia' as puede_pasar_lista %}
      {% if puede_pasar_lista %}
        <a href="{% url 'reuniones:lista_asistencia' reunion.pk %}" class="btn btn-primary">Registrar Asistencia</a>
      {% endif %}

      {% if puede_editar_acta %}
        <a href="{% url 'reuniones:editar_acta' reunion.pk %}" class="btn btn-info">Editar Acta</a>
      {% endif %}

      {% if reunion.acta %}
        <a href="{% url 'reuniones:exportar_acta_pdf' reunion.pk %}" class="btn btn-success">Exportar a PDF</a>
        <!-- NUEVO: bot√≥n para abrir el modal de env√≠o -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalEnviarActa">
          Enviar por correo
        </button>
      {% endif %}
    </div>
  </div>

  <div class="card-footer text-muted small">
    Reuni√≥n creada por {{ reunion.creada_por.username }} el {{ reunion.creada_el|date:"d/m/Y" }}
  </div>
</div>

{% if reunion.acta %}
<!-- ===========================
     Modal: Enviar Acta por correo (con lista de usuarios)
     =========================== -->
<div class="modal fade" id="modalEnviarActa" tabindex="-1" aria-labelledby="modalEnviarActaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formEnviarActa" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalEnviarActaLabel">Enviar Acta por correo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <!-- Barra superior: buscar + seleccionar todo -->
          <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
            <div class="flex-grow-1">
              <input type="text" id="filtroCorreos" class="form-control" placeholder="Buscar por nombre o correo‚Ä¶">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkSelectAll">
              <label class="form-check-label" for="chkSelectAll">Seleccionar todos</label>
            </div>
          </div>

          <!-- Lista de usuarios con email -->
          <div id="listaCorreos" class="border rounded p-2" style="max-height: 320px; overflow: auto;">
            {% for u in destinatarios %}
              {% if u.email %}
              <div class="form-check py-1 item-email"
                   data-name="{{ u.get_full_name|default:u.username|lower }}"
                   data-email="{{ u.email|lower }}">
                <input class="form-check-input chk-email" type="checkbox" value="{{ u.email }}" id="u{{ u.id }}">
                <label class="form-check-label" for="u{{ u.id }}">
                  {{ u.get_full_name|default:u.username }}
                  <small class="text-muted">&lt;{{ u.email }}&gt;</small>
                </label>
              </div>
              {% endif %}
            {% empty %}
              <div class="text-muted">No hay usuarios con correo cargados.</div>
            {% endfor %}
          </div>

          <!-- Correos adicionales opcionales -->
          <div class="mt-3">
            <label for="inputCorreosExtra" class="form-label">Correos adicionales (opcional)</label>
            <input id="inputCorreosExtra" name="correos" type="text" class="form-control"
                   placeholder="ej: extra1@mail.com, extra2@mail.com">
            <small class="text-muted">Puedes escribir varios correos separados por coma.</small>
          </div>

          <div id="sendStatus" class="small mt-2 text-muted"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnEnviarCorreo">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% if puede_editar_acta %}
<!-- === SCRIPT STT + GUARDAR + LIMPIAR === -->
<script>
(function(){
  const reunionId  = "{{ reunion.id }}";
  const saveUrl    = "{% url 'reuniones:guardar_borrador_acta' reunion.pk %}";
  const approveUrl = "{% url 'reuniones:aprobar_borrador_acta' reunion.pk %}";

  const $      = (id)=>document.getElementById(id);
  const ta     = $('contenido_acta');
  const status = $('saveStatus');

  // ---------- Utilidades ----------
  function getCSRF(){
    const el = document.querySelector('input[name=csrfmiddlewaretoken]');
    if (el) return el.value;
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }
  function setOk(msg){ status.classList.remove('text-danger'); status.classList.add('text-success'); status.textContent = msg; }
  function setErr(msg){ status.classList.remove('text-success'); status.classList.add('text-danger'); status.textContent = msg; }

  // ---------- Guardado ----------
  async function guardarBorrador(){
    const resp = await fetch(saveUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},
      body: JSON.stringify({contenido: ta.value})
    });
    if (!resp.ok) throw new Error('Error al guardar borrador');
    const data = await resp.json();
    if (!data.ok) throw new Error('No se pudo guardar');
    return data;
  }
  async function aprobarBorrador(){
    const resp = await fetch(approveUrl, { method:'POST', headers:{'X-CSRFToken':getCSRF()} });
    if (!resp.ok) throw new Error('Error al confirmar guardado');
  }
  async function guardarSolo(){
    try{
      if (typeof stopSTT === 'function') { await stopSTT(); }
      await guardarBorrador();
      await aprobarBorrador();
      setOk('Guardado correctamente');
    }catch(err){
      console.error(err);
      setErr(err?.message || 'Error al guardar');
    }
  }
  $('btnGuardarSolo')?.addEventListener('click', (e)=>{ e.preventDefault(); guardarSolo(); });

  // ---------- Limpiar ----------
  function limpiarContenidoUI(){
    ta.value = '';
    const parcial = $('sttPartial');
    if (parcial) parcial.textContent = '';
    status.classList.remove('text-success','text-danger');
    status.textContent = '';
  }
  $('btnLimpiar')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (!confirm('¬øSeguro que deseas limpiar el contenido actual?')) return;
    limpiarContenidoUI();
  });

  // ---------- STT por WebSocket ----------
  let ws=null, mediaStream=null, audioCtx=null, processor=null;
  let autosaveTimer=null, lastFinalText="";

  function setStatus(t){ const el=$('sttStatus'); if(el) el.textContent=t; }

  function downsampleTo16kInt16(float32, inRate){
    const outRate=16000;
    if(inRate===outRate){
      const buf=new ArrayBuffer(float32.length*2), view=new DataView(buf);
      for(let i=0,off=0;i<float32.length;i++,off+=2){
        let s=Math.max(-1,Math.min(1,float32[i]));
        view.setInt16(off, s<0?s*0x8000:s*0x7fff, true);
      }
      return buf;
    }
    const ratio=inRate/outRate, newLen=Math.round(float32.length/ratio);
    const out=new Int16Array(newLen); let i=0,j=0;
    while(i<newLen){
      const nextJ=Math.round((i+1)*ratio); let sum=0,c=0;
      while(j<nextJ && j<float32.length){ sum+=float32[j++]; c++; }
      const s=Math.max(-1,Math.min(1,sum/(c||1)));
      out[i++]= s<0 ? s*0x8000 : s*0x7fff;
    }
    return out.buffer;
  }

  async function startSTT(){
    try{
      if (ws && ws.readyState===WebSocket.OPEN) return;
      const scheme = location.protocol==='https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${scheme}://${location.host}/ws/transcribir/${reunionId}/`);
      ws.binaryType = 'arraybuffer';

      ws.onopen = async ()=>{
        setStatus('üéß Escuchando‚Ä¶');
        $('btnStartSTT').disabled = true;
        $('btnStopSTT').disabled  = false;

        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if (audioCtx.state==='suspended') await audioCtx.resume();

        const source = audioCtx.createMediaStreamSource(mediaStream);
        processor = audioCtx.createScriptProcessor(2048,1,1);
        processor.onaudioprocess = (e)=>{
          if (!ws || ws.readyState!==WebSocket.OPEN) return;
          const chan = e.inputBuffer.getChannelData(0);
          ws.send(downsampleTo16kInt16(chan, audioCtx.sampleRate));
        };
        source.connect(processor);
        const nullGain = audioCtx.createGain(); nullGain.gain.value=0;
        processor.connect(nullGain); nullGain.connect(audioCtx.destination);

        autosaveTimer = setInterval(async ()=>{ try{ await guardarBorrador(); }catch(_){ } }, 12000);
      };

      ws.onmessage = (evt)=>{
        const data = JSON.parse(evt.data);
        if (data.type==='partial'){
          const el=$('sttPartial'); if(el) el.textContent=data.text;
        }else if (data.type==='final'){
          const txt=(data.text||'').trim();
          if(!txt || txt===lastFinalText) return;
          lastFinalText=txt;
          ta.value = (ta.value ? ta.value.trim()+' ' : '') + txt;
          const el=$('sttPartial'); if(el) el.textContent='';
        }else if (data.type==='status'){ setStatus(data.msg); }
      };

      ws.onerror = (e)=>{ console.error('WS error',e); setStatus('Error de WebSocket'); };
      ws.onclose = ()=>{
        setStatus('Micr√≥fono inactivo');
        $('btnStartSTT').disabled=false; $('btnStopSTT').disabled=true;
        if (autosaveTimer){ clearInterval(autosaveTimer); autosaveTimer=null; }
        guardarBorrador().catch(()=>{});
      };
    }catch(err){
      console.error(err);
      setStatus('Error micr√≥fono/WS');
      $('btnStartSTT').disabled=false; $('btnStopSTT').disabled=true;
      if (autosaveTimer){ clearInterval(autosaveTimer); autosaveTimer=null; }
      guardarBorrador().catch(()=>{});
      alert((err && (err.name||err.message)) || err);
    }
  }

  async function stopSTT(){
    try{
      if (processor){ processor.disconnect(); processor=null; }
      if (audioCtx){ await audioCtx.close(); audioCtx=null; }
      if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      if (ws && ws.readyState===WebSocket.OPEN){ ws.close(); }
    } finally {
      $('btnStartSTT').disabled=false; $('btnStopSTT').disabled=true;
      setStatus('Micr√≥fono inactivo');
      if (autosaveTimer){ clearInterval(autosaveTimer); autosaveTimer=null; }
      guardarBorrador().catch(()=>{});
    }
  }

  // Botones STT
  $('btnStartSTT')?.addEventListener('click', startSTT);
  $('btnStopSTT')?.addEventListener('click', stopSTT);

  // Guarda al salir
  window.addEventListener('beforeunload', ()=>{
    if (autosaveTimer){ clearInterval(autosaveTimer); autosaveTimer=null; }
    try{
      if (navigator.sendBeacon){
        const blob = new Blob([JSON.stringify({contenido: ta.value})], {type:'application/json'});
        navigator.sendBeacon(saveUrl, blob);
      }
    }catch(_){}
  });
})();
</script>
{% endif %}

{% if reunion.acta %}
<!-- === SCRIPT: Enviar acta por correo (checkboxes + buscar + seleccionar todo) === -->
<script>
(function(){
  const form = document.getElementById('formEnviarActa');
  if (!form) return;

  function getCSRF(){
    const el = document.querySelector('#formEnviarActa input[name=csrfmiddlewaretoken]');
    if (el) return el.value;
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  const statusEl = document.getElementById('sendStatus');
  function setSend(msg, ok=true){
    statusEl.classList.toggle('text-danger', !ok);
    statusEl.classList.toggle('text-success', ok);
    statusEl.textContent = msg;
  }

  // --- Buscar en la lista ---
  const filtro = document.getElementById('filtroCorreos');
  const items  = Array.from(document.querySelectorAll('#listaCorreos .item-email'));
  filtro?.addEventListener('input', function(){
    const q = (this.value || '').trim().toLowerCase();
    if (!q){
      items.forEach(it => it.style.display = '');
      return;
    }
    items.forEach(it => {
      const hay = it.dataset.name.includes(q) || it.dataset.email.includes(q);
      it.style.display = hay ? '' : 'none';
    });
  });

  // --- Seleccionar todo visible ---
  const chkAll = document.getElementById('chkSelectAll');
  chkAll?.addEventListener('change', function(){
    const visibles = items.filter(it => it.style.display !== 'none');
    visibles.forEach(it => {
      const cb = it.querySelector('.chk-email');
      if (cb) cb.checked = chkAll.checked;
    });
  });

  // --- Enviar ---
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    setSend('Enviando‚Ä¶', true);

    // 1) Correos de checkboxes marcados
    const marcados = Array
      .from(document.querySelectorAll('.chk-email:checked'))
      .map(cb => (cb.value || '').trim())
      .filter(Boolean);

    // 2) Correos adicionales (separados por coma)
    const extrasStr = (document.getElementById('inputCorreosExtra')?.value || '').trim();
    const extras = extrasStr
      ? extrasStr.split(',').map(s => s.trim()).filter(Boolean)
      : [];

    const todos = [...new Set([...marcados, ...extras])]; // √∫nicos

    if (todos.length === 0){
      setSend('Selecciona al menos un correo (o escribe uno adicional).', false);
      return;
    }

    const fd = new FormData();
    todos.forEach(c => fd.append('correos[]', c)); // la vista soporta 'correos[]'

    try{
      const resp = await fetch("{% url 'reuniones:enviar_acta_pdf_por_correo' reunion.pk %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRF() },
        body: fd
      });

      if (!resp.ok){
        const txt = await resp.text();
        setSend('Error: ' + (txt || 'No se pudo enviar'), false);
        return;
      }

      const data = await resp.json();
      if (data.ok){
        setSend('¬°Acta enviada correctamente!', true);
        setTimeout(()=>{
          const modalEl = document.getElementById('modalEnviarActa');
          if (modalEl && window.bootstrap){
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
          }
          setSend('');
          form.reset();
          document.querySelectorAll('.chk-email').forEach(cb => cb.checked = false);
          const chkAll = document.getElementById('chkSelectAll');
          if (chkAll) chkAll.checked = false;
        }, 900);
      }else{
        setSend(data.mensaje || 'No se pudo enviar', false);
      }
    }catch(err){
      console.error(err);
      setSend('Error inesperado al enviar', false);
    }
  });
})();
</script>
{% endif %}
{% endblock %}
