{% extends "base.html" %}
{% load can %}
{% load widget_tweaks %}

{% block title %}Detalle de Reuniรณn{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
ย ย <a href="{% url 'reuniones:lista_reuniones' %}" class="btn btn-secondary btn-sm">
ย ย ย ย <i class="fas fa-arrow-left me-1"></i> Volver a la lista
ย ย </a>
ย ย 
ย ย {# Etiqueta de Estado #}
ย ย {% if reunion.estado == 'PROGRAMADA' %}
ย ย ย ย <span class="badge bg-secondary fs-6">Programada</span>
ย ย {% elif reunion.estado == 'EN_CURSO' %}
ย ย ย ย <span class="badge bg-success fs-6">En Curso</span>
ย ย {% elif reunion.estado == 'REALIZADA' %}
ย ย ย ย <span class="badge bg-dark fs-6">Realizada</span>
ย ย {% elif reunion.estado == 'CANCELADA' %}
ย ย ย ย <span class="badge bg-danger fs-6">Cancelada</span>
ย ย {% endif %}
</div>

<div class="card shadow-sm mb-4">
ย <div class="card-header">
ย ย <h1 class="h4 mb-0">{{ reunion.titulo }}</h1>
ย </div>
ย <div class="card-body">
ย ย <div class="row mb-3">
ย ย ย ย <div class="col-md-6">
ย ย ย ย ย ย <p><strong><i class="fas fa-info-circle me-1"></i> Tipo:</strong> {{ reunion.tipo }}</p>
ย ย ย ย </div>
ย ย ย ย <div class="col-md-6">
ย ย ย ย ย ย <p><strong><i class="fas fa-calendar-alt me-1"></i> Fecha:</strong> {{ reunion.fecha|date:"d/m/Y H:i" }} hrs</p>
ย ย ย ย </div>
ย ย </div>

ย ย <h5 class="mt-4">Tabla de Contenidos (Temas a tratar)</h5>
ย ย <div class="p-3 bg-light rounded border">
ย ย ย {{ reunion.tabla|linebreaksbr }}
ย ย </div>
ย </div>
</div>

{% user_can 'reuniones' 'change_estado' as puede_cambiar_estado %}
{% user_can 'reuniones' 'cancel' as puede_cancelar %}

{% if puede_cambiar_estado or puede_cancelar %}
<div class="card shadow-sm mb-4">
ย ย <div class="card-header">
ย ย ย ย <h5 class="mb-0">Acciones de Reuniรณn</h5>
ย ย </div>
ย ย <div class="card-body text-center d-flex justify-content-center align-items-center gap-3">
ย ย ย ย 
ย ย ย ย {% if reunion.estado == 'PROGRAMADA' %}
ย ย ย ย ย ย {% if puede_cambiar_estado %}
ย ย ย ย ย ย <form action="{% url 'reuniones:iniciar_reunion' reunion.pk %}" method="POST" class="d-inline">
ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-success btn-lg">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-play me-1"></i> Iniciar Reuniรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย 
ย ย ย ย ย ย {% if puede_cancelar %}
ย ย ย ย ย ย <form action="{% url 'reuniones:cancelar_reunion' reunion.pk %}" method="POST" class="d-inline" onsubmit="return confirm('ยฟEstรกs seguro de que quieres CANCELAR esta reuniรณn?');">
ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-danger btn-lg">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-ban me-1"></i> Cancelar Reuniรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย ย ย {% endif %}
ย ย ย ย 
ย ย ย ย {% elif reunion.estado == 'EN_CURSO' %}
ย ย ย ย ย ย {% if puede_cambiar_estado %}
ย ย ย ย ย ย <form action="{% url 'reuniones:finalizar_reunion' reunion.pk %}" method="POST" class="d-inline">
ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-danger btn-lg">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-stop me-1"></i> Finalizar Reuniรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย ย ย {% endif %}
ย ย ย ย 
ย ย ย ย {% elif reunion.estado == 'REALIZADA' %}
ย ย ย ย ย ย <p class="lead text-muted m-0">Esta reuniรณn ya ha finalizado.</p>
ย ย ย ย 
ย ย ย ย {% elif reunion.estado == 'CANCELADA' %}
ย ย ย ย ย ย <p class="lead text-danger m-0">Esta reuniรณn fue cancelada.</p>
ย ย ย ย {% endif %}
ย ย </div>
</div>
{% endif %}


{% user_can 'actas' 'edit' as puede_editar_acta %}
{% user_can 'actas' 'view' as puede_ver_acta %}

{# Solo muestra la gestiรณn de actas si la reuniรณn estรก EN CURSO o REALIZADA #}
{% if reunion.estado == 'EN_CURSO' or reunion.estado == 'REALIZADA' %}
<div class="card shadow-sm">
ย ย <div class="card-header d-flex justify-content-between align-items-center">
ย ย ย ย <h5 class="mb-0">Gestiรณn del Acta</h5>
ย ย ย ย {% if acta.aprobada %}
ย ย ย ย ย ย <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Acta Aprobada</span>
ย ย ย ย {% else %}
ย ย ย ย ย ย <span class="badge bg-warning text-dark"><i class="fas fa-edit me-1"></i> Acta en Borrador</span>
ย ย ย ย {% endif %}
ย ย </div>

ย ย <div class="card-body">
ย ย ย ย 
ย ย ย ย {% if puede_editar_acta %}
ย ย ย ย 
ย ย ย ย {# LรGICA 2: El botรณn de transcribir SOLO aparece si la reuniรณn estรก EN CURSO #}
ย ย ย ย {% if reunion.estado == 'EN_CURSO' %}
ย ย ย ย <div class="d-flex align-items-center gap-2 mb-3 p-3 border rounded bg-light">
ย ย ย ย ย ย <button id="btnStartSTT" class="btn btn-danger">๐๏ธ Iniciar Transcripciรณn</button>
ย ย ย ย ย ย <button id="btnStopSTT" ยclass="btn btn-outline-secondary" disabled>โน๏ธ Detener</button>
ย ย ย ย ย ย <span id="sttStatus" class="text-muted small">Micrรณfono inactivo</span>
ย ย ย ย </div>
ย ย ย ย <div id="audioPreviewContainer" class="mt-3 p-3 border rounded bg-light" style="display: none;">
ย ย ย ย ย ย <h6 class="mb-2">Previsualizaciรณn del Audio Grabado</h6>
ย ย ย ย ย ย 
ย ย ย ย ย ย <audio id="audioPlayer" controls class="w-100 mb-2"></audio>
ย ย ย ย ย ย 
ย ย ย ย ย ย <a id="downloadAudioLink" class="btn btn-success btn-sm" href="#" download>
ย ย ย ย ย ย ย ย <i class="fas fa-download me-1"></i>
ย ย ย ย ย ย ย ย Descargar Audio Grabado
ย ย ย ย ย ย </a>
ย ย ย ย ย ย <small id="audioFileName" class="text-muted ms-2"></small>
ย ย ย ย </div>
ย ย ย ย {% elif not acta.aprobada %}
ย ย ย ย <div class="alert alert-info small">
ย ย ย ย ย ย La transcripciรณn en vivo solo estรก disponible mientras la reuniรณn estรก "En Curso".
ย ย ย ย </div>
ย ย ย ย {% endif %}

ย ย ย ย <form method="POST" action="{% url 'reuniones:guardar_borrador_acta' reunion.pk %}">
ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย {# El acta se puede editar si NO estรก aprobada #}
ย ย ย ย ย ย {% if not acta.aprobada %}
ย ย ย ย ย ย ย ย {% render_field acta_form.contenido class="form-control" rows="15" id="actaContenido" %}
ย ย ย ย ย ย ย ย <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
ย ย ย ย ย ย ย ย ย ย <span id="autosave-status" class="text-muted small me-2"></span>
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-primary">
ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-save me-1"></i> Guardar Borrador
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย <p class="text-muted small">El acta ya estรก aprobada y no se puede editar.</p>
ย ย ย ย ย ย ย ย <div class="p-3 bg-light rounded border">
ย ย ย ย ย ย ย ย ย ย {{ acta_form.contenido.value|linebreaksbr }}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย {% endif %}
ย ย ย ย </form>
ย ย ย ย {% if reunion.estado == 'REALIZADA' and not acta.aprobada %}
ย ย ย ย <div class="card bg-light mt-4">
ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย <h5 class="card-title">๐ค Procesar Audio de Respaldo (Vosk)</h5>
ย ย ย ย ย ย ย ย <p class="small text-muted">
ย ย ย ย ย ย ย ย ย ย Si el borrador actual no es bueno, puedes subir el archivo de audio (`.webm`, `.ogg`) 
ย ย ย ย ย ย ย ย ย ย que descargaste. El sistema lo procesarรก en segundo plano y 
ย ย ย ย ย ย ย ย ย ย reemplazarรก el contenido del acta con la transcripciรณn completa.
ย ย ย ย ย ย ย ย </p>

ย ย ย ย ย ย ย ย {# --- FORMULARIO DE SUBIDA --- #}
ย ย ย ย ย ย ย ย <form action="{% url 'reuniones:subir_audio_acta' reunion.pk %}" method="POST" enctype="multipart/form-data">
ย ย ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย ย ย <div class="input-group">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" class="form-control" name="archivo_audio" id="audio_file_input" accept=".webm,.ogg,.wav,.mp3">
ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-outline-danger" type="submit" id="btnSubirAudio">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-upload me-1"></i> Subir y Procesar
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </form>

ย ย ย ย ย ย ย ย {# --- ESTADO DEL PROCESAMIENTO --- #}
ย ย ย ย ย ย ย ย {% if acta.estado_transcripcion == 'PENDIENTE' or acta.estado_transcripcion == 'PROCESANDO' %}
ย ย ย ย ย ย ย ย <div id="transcripcion-pendiente" class="alert alert-warning small mt-3" role="alert">
ย ย ย ย ย ย ย ย ย ย <div class="spinner-border spinner-border-sm me-1" role="status">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="visually-hidden">Procesando...</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <strong>Estado: {{ acta.get_estado_transcripcion_display }}</strong>
ย ย ย ย ย ย ย ย ย ย <p class="mb-0 mt-1">
ย ย ย ย ย ย ย ย ย ย ย ย El audio se estรก procesando en el servidor. El acta se actualizarรก automรกticamente 
ย ย ย ย ย ย ย ย ย ย ย ย cuando termine. Puedes recargar esta pรกgina para ver el estado.
ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย {% elif acta.estado_transcripcion == 'COMPLETADO' %}
ย ย ย ย ย ย ย ย <div class="alert alert-success small mt-3" role="alert">
ย ย ย ย ย ย ย ย ย ย <strong>Estado: {{ acta.get_estado_transcripcion_display }}</strong>
ย ย ย ย ย ย ย ย ย ย <p class="mb-0 mt-1">El acta se ha actualizado con la transcripciรณn del audio.</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย {% elif acta.estado_transcripcion == 'ERROR' %}
ย ย ย ย ย ย ย ย <div class="alert alert-danger small mt-3" role="alert">
ย ย ย ย ย ย ย ย ย ย <strong>Estado: {{ acta.get_estado_transcripcion_display }}</strong>
ย ย ย ย ย ย ย ย ย ย <p class="mb-0 mt-1">Hubo un error al procesar el audio.</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย {% endif %}

ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย {% endif %}
ย ย ย ย <hr class="my-4">

ย ย ย ย <div class="d-flex flex-wrap gap-2">
ย ย ย ย ย ย 
ย ย ย ย ย ย {# LรGICA 3: Aprobar SOLO si la reuniรณn estรก REALIZADA #}
ย ย ย ย ย ย {% if not acta.aprobada and reunion.estado == 'REALIZADA' %}
ย ย ย ย ย ย <form method="POST" action="{% url 'reuniones:aprobar_borrador_acta' reunion.pk %}" onsubmit="return confirm('ยฟEstรกs seguro de que quieres APROBAR esta acta? Ya no podrรกs editarla.');" class="d-inline">
ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-success">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-check me-1"></i> Aprobar Acta
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย ย ย {% elif not acta.aprobada and reunion.estado == 'EN_CURSO' %}
ย ย ย ย ย ย <button type="button" class="btn btn-success" disabled title="Debes finalizar la reuniรณn para poder aprobar el acta.">
ย ย ย ย ย ย ย ย <i class="fas fa-check me-1"></i> Aprobar Acta
ย ย ย ย ย ย </button>
ย ย ย ย ย ย {% endif %}

ย ย ย ย ย ย {% if acta.aprobada %}
ย ย ย ย ย ย <form method="POST" action="{% url 'reuniones:rechazar_acta' reunion.pk %}" onsubmit="return confirm('ยฟEstรกs seguro de que quieres QUITAR LA APROBACIรN de esta acta? Volverรก a ser un borrador editable.');" class="d-inline">
ย ย ย ย ย ย ย ย {% csrf_token %}
ย ย ย ย ย ย ย ย <button type="submit" class="btn btn-warning">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-undo me-1"></i> Quitar Aprobaciรณn
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย ย ย {% endif %}

ย ย ย ย ย ย <a href="{% url 'reuniones:exportar_acta_pdf' reunion.pk %}" target="_blank" class="btn btn-outline-danger">
ย ย ย ย ย ย ย ย <i class="fas fa-file-pdf me-1"></i> Exportar a PDF
ย ย ย ย ย ย </a>
ย ย ย ย ย ย <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalEnviarActa">
ย ย ย ย ย ย ย ย <i class="fas fa-envelope me-1"></i> Enviar por Correo
ย ย ย ย ย ย </button>
ย ย ย ย ย ย <a href="{% url 'reuniones:lista_asistencia' reunion.pk %}" class="btn btn-outline-secondary">
ย ย ย ย ย ย ย ย <i class="fas fa-users me-1"></i> Ver Asistencia ({{ asistentes.count }})
ย ย ย ย ย ย </a>
ย ย ย ย </div>
ย ย ย ย 
ย ย ย ย {% elif puede_ver_acta %}
ย ย ย ย ย ย <h5 class="mt-4">Contenido del Acta (Solo lectura)</h5>
ย ย ย ย ย ย {% if acta.aprobada %}
ย ย ย ย ย ย ย ย <div class="p-3 bg-light rounded border">
ย ย ย ย ย ย ย ย ย ย {{ acta.contenido|linebreaksbr }}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <a href="{% url 'reuniones:exportar_acta_pdf' reunion.pk %}" target="_blank" class="btn btn-outline-danger mt-3">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-file-pdf me-1"></i> Descargar PDF
ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย <div class="alert alert-warning">El acta de esta reuniรณn aรบn es un borrador y no estรก disponible para visualizaciรณn.</div>
ย ย ย ย ย ย {% endif %}
ย ย ย ย {% endif %}
ย ย </div>
</div>
{% endif %} 
{# Fin del if reunion.estado != 'PROGRAMADA' #}


<div class="modal fade" id="modalEnviarActa" tabindex="-1" aria-labelledby="modalEnviarActaLabel" aria-hidden="true">
ย <div class="modal-dialog modal-lg modal-dialog-scrollable">
ย ย <div class="modal-content">
ย ย ย <div class="modal-header">
ย ย ย ย <h5 class="modal-title" id="modalEnviarActaLabel">Enviar Acta por Correo</h5>
ย ย ย ย <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
ย ย ย ย </div>
ย ย ย <form id="formEnviarEmail">
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <p>Selecciona los destinatarios para enviar el PDF del acta.</p>
ย ย ย ย ย 
ย ย ย ย ย <div id="email-error-msg" class="alert alert-danger" style="display: none;"></div>
ย ย ย ย ย <div id="email-success-msg" class="alert alert-success" style="display: none;"></div>

ย ย ย ย ย <div class="mb-3">
ย ย ย ย ย ย <label for="correos_adicionales" class="form-label">Correos adicionales (separados por coma):</label>
ย ย ย ย ย ย <textarea class="form-control" id="correos_adicionales" rows="2"></textarea>
ย ย ย ย ย </div>
ย ย ย ย ย 
ย ย ย ย ย <div class="p-3 border rounded" style="max-height: 300px; overflow-y: auto;">
ย ย ย ย ย ย <div class="form-check">
ย ย ย ย ย ย ย <input class="form-check-input" type="checkbox" id="chkTodosVecinos">
ย ย ย ย ย ย ย <label class="form-check-label fw-bold" for="chkTodosVecinos">
ย ย ย ย ย ย ย ย Enviar a todos los vecinos ({{ total_vecinos }})
ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <hr>
ย ย ย ย ย ย <p class="small text-muted">O selecciona individualmente (solo vecinos que NO asistieron):</p>
ย ย ย ย ย ย <ul class="list-unstyled" id="lista-correos-vecinos">
ย ย ย ย ย ย ย {% for perfil in vecinos_para_email %}
ย ย ย ย ย ย ย ย {% if perfil.usuario.email %}
ย ย ย ย ย ย ย ย <li class="form-check">
ย ย ย ย ย ย ย ย ย <input class="form-check-input chk-email" type="checkbox" 
ย ย ย ย ย ย ย ย ย ย ย ย ยvalue="{{ perfil.usuario.email }}" id="chk-vecino-{{ perfil.id }}">
ย ย ย ย ย ย ย ย ย <label class="form-check-label" for="chk-vecino-{{ perfil.id }}">
ย ย ย ย ย ย ย ย ย ย {{ perfil.usuario.get_full_name }} ({{ perfil.usuario.email }})
ย ย ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย ย ย </li>
ย ย ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย ย {% empty %}
ย ย ย ย ย ย ย ย <li>Todos los vecinos asistieron o no hay vecinos registrados.</li>
ย ย ย ย ย ย ย {% endfor %}
ย ย ย ย ย ย </ul>
ย ย ย ย ย </div>
ย ย ย ย ย 
ย ย ย ย </div>
ย ย ย ย <div class="modal-footer">
ย ย ย ย ย <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
ย ย ย ย ย <button type="submit" class="btn btn-primary" id="btnEnviarCorreo">
ย ย ย ย ย ย <span id="btnEnviarTexto">Enviar</span>
ย ย ย ย ย ย <span id="btnEnviarSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
ย ย ย ย ย </button>
ย ย ย ย </div>
ย ย ย </form>
ย ย </div>
ย </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
// Funciรณn CSRF
function getCSRF() {
ย ย return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// 1. Lรณgica de Transcripciรณn (STT), GRABACIรN y AUTOGUARDADO
document.addEventListener('DOMContentLoaded', () => {
ย ย const btnStart = document.getElementById('btnStartSTT');
ย ย const btnStop = document.getElementById('btnStopSTT');
ย ย const sttStatus = document.getElementById('sttStatus');
ย ย const actaTextarea = document.getElementById('actaContenido');

ย ย // --- NUEVOS ELEMENTOS DEL DOM PARA EL PREVIEW ---
ย ย const audioPreviewContainer = document.getElementById('audioPreviewContainer');
ย ย const audioPlayer = document.getElementById('audioPlayer');
ย ย const downloadAudioLink = document.getElementById('downloadAudioLink');
ย ย const audioFileName = document.getElementById('audioFileName');

ย ย // SI NO EXISTE EL BOTรN (porque la reuniรณn no estรก en curso), no hacemos nada.
ย ย if (!btnStart) {
ย ย ย ย return;
ย ย }

ย ย // --- CรDIGO AUTOGUARDADO (INTACTO) ---
ย ย const autosaveStatus = document.getElementById('autosave-status');
ย ย let autosaveTimer = null;
ย ย const AUTOSAVE_DELAY = 2500; 

ย ย async function guardarBorrador() {
ย ย ย ย if (!actaTextarea || !autosaveStatus) return;
ย ย ย ย autosaveStatus.textContent = 'Guardando...';
ย ย ย ย autosaveStatus.classList.remove('text-success', 'text-danger');
ย ย ย ย autosaveStatus.classList.add('text-muted');

ย ย ย ย const formData = new FormData();
ย ย ย ย formData.append('contenido', actaTextarea.value);

ย ย ย ย try {
ย ย ย ย ย ย const response = await fetch("{% url 'reuniones:guardar_borrador_acta' reunion.pk %}", {
ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย headers: {
ย ย ย ย ย ย ย ย ย ย 'X-CSRFToken': getCSRF(),
ย ย ย ย ย ย ย ย ย ย 'X-Requested-With': 'XMLHttpRequest'
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย body: formData
ย ย ย ย ย ย });

ย ย ย ย ย ย if (response.ok) {
ย ย ย ย ย ย ย ย autosaveStatus.textContent = 'Borrador guardado.';
ย ย ย ย ย ย ย ย autosaveStatus.classList.add('text-success');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย autosaveStatus.textContent = 'Error al guardar.';
ย ย ย ย ย ย ย ย autosaveStatus.classList.add('text-danger');
ย ย ย ย ย ย }
ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error('Error en autoguardado:', error);
ย ย ย ย ย ย autosaveStatus.textContent = 'Error de red.';
ย ย ย ย ย ย autosaveStatus.classList.add('text-danger');
ย ย ย ย }
ย ย }

ย ย function triggerAutosave() {
ย ย ย ย if (autosaveTimer) {
ย ย ย ย ย ย clearTimeout(autosaveTimer);
ย ย ย ย }
ย ย ย ย autosaveTimer = setTimeout(guardarBorrador, AUTOSAVE_DELAY);
ย ย }
ย ย // --- FIN CรDIGO AUTOGUARDADO ---


ย ย // Verificamos si el navegador soporta la API
ย ย const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
ย ย if (!SpeechRecognition) {
ย ย ย ย if(btnStart) btnStart.disabled = true;
ย ย ย ย if(sttStatus) sttStatus.textContent = "Transcripciรณn no soportada en este navegador.";
ย ย ย ย return;
ย ย }

ย ย // --- INICIO LรGICA DE GRABACIรN Y TRANSCRIPCIรN ---

ย ย // Variables "maestras"
ย ย let micStream = null;
ย ย let mediaRecorder = null;
ย ย let audioChunks = [];

ย ย const recognition = new SpeechRecognition();
ย ย recognition.lang = 'es-ES';
ย ย recognition.continuous = true;
ย ย recognition.interimResults = true; 

ย ย let finalTranscript = actaTextarea ? actaTextarea.value : '';

ย ย recognition.onstart = () => {
ย ย ย ย sttStatus.textContent = '๐๏ธ Escuchando...';
ย ย ย ย btnStart.disabled = true;
ย ย ย ย btnStop.disabled = false;
ย ย };

ย ย recognition.onend = () => {
ย ย ย ย sttStatus.textContent = 'Micrรณfono inactivo';
ย ย ย ย btnStart.disabled = false;
ย ย ย ย btnStop.disabled = true;
ย ย ย ย triggerAutosave();
ย ย };

ย ย recognition.onresult = (event) => {
ย ย ย ย let interimTranscript = '';
ย ย ย ย for (let i = event.resultIndex; i < event.results.length; ++i) {
ย ย ย ย ย ย if (event.results[i].isFinal) {
ย ย ย ย ย ย ย ย // CORRECCIรN AQUร: Usar '\n' simple para un carรกcter de nueva lรญnea real
ย ย ย ย ย ย ย ย finalTranscript += event.results[i][0].transcript + '.\n'; 
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย interimTranscript += event.results[i][0].transcript;
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย if (actaTextarea) {
ย ย ย ย ย ย actaTextarea.value = finalTranscript + interimTranscript;
ย ย ย ย ย ย actaTextarea.scrollTop = actaTextarea.scrollHeight;
ย ย ย ย ย ย triggerAutosave();
ย ย ย ย }
ย ย };

ย ย recognition.onerror = (event) => {
ย ย ย ย console.error('Error de reconocimiento:', event.error);
ย ย ย ย sttStatus.textContent = 'Error: ' + event.error;
ย ย };

ย ย // --- BOTรN INICIAR (MODIFICADO) ---
ย ย if(btnStart) {
ย ย ย ย btnStart.addEventListener('click', async () => {

ย ย ย ย ย ย // --- OCULTAR Y LIMPIAR PREVIEW ANTERIOR ---
ย ย ย ย ย ย if (audioPlayer.src) {
ย ย ย ย ย ย ย ย // Revoca la URL del Blob anterior para liberar memoria
ย ย ย ย ย ย ย ย URL.revokeObjectURL(audioPlayer.src);
ย ย ย ย ย ย ย ย audioPlayer.src = null;
ย ย ย ย ย ย }
ย ย ย ย ย ย if(audioPreviewContainer) audioPreviewContainer.style.display = 'none';
ย ย ย ย ย ย if(audioFileName) audioFileName.textContent = '';
ย ย ย ย ย ย // ------------------------------------------

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // 1. Pedir el stream del micrรณfono
ย ย ย ย ย ย ย ย micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

ย ย ย ย ย ย ย ย // 2. Configurar el GRABADOR (MediaRecorder)
ย ย ย ย ย ย ย ย audioChunks = []; // Limpiar chunks
ย ย ย ย ย ย ย ย mediaRecorder = new MediaRecorder(micStream);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // 2a. Cuando el grabador tenga datos, los guarda
ย ย ย ย ย ย ย ย mediaRecorder.ondataavailable = (event) => {
ย ย ย ย ย ย ย ย ย ย audioChunks.push(event.data);
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย // --- 2b. LรGICA DE PREVISUALIZACIรN (MODIFICADO) ---
ย ย ย ย ย ย ย ย // Se activa al llamar a mediaRecorder.stop()
ย ย ย ย ย ย ย ย mediaRecorder.onstop = () => {
ย ย ย ย ย ย ย ย ย ย const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
ย ย ย ย ย ย ย ย ย ย const audioUrl = URL.createObjectURL(audioBlob);

ย ย ย ย ย ย ย ย ย ย // 1. Asignar el audio al reproductor
ย ย ย ย ย ย ย ย ย ย if(audioPlayer) audioPlayer.src = audioUrl;

ย ย ย ย ย ย ย ย ย ย // 2. Asignar la URL al botรณn de descarga
ย ย ย ย ย ย ย ย ย ย const nombreArchivo = `grabacion-reunion-{{ reunion.pk }}-${new Date().toISOString().split('T')[0]}.webm`;
ย ย ย ย ย ย ย ย ย ย if(downloadAudioLink) {
ย ย ย ย ย ย ย ย ย ย ย ย downloadAudioLink.href = audioUrl;
ย ย ย ย ย ย ย ย ย ย ย ย downloadAudioLink.download = nombreArchivo;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย if(audioFileName) audioFileName.textContent = nombreArchivo;

ย ย ย ย ย ย ย ย ย ย // 3. Mostrar el contenedor del preview
ย ย ย ย ย ย ย ย ย ย if(audioPreviewContainer) audioPreviewContainer.style.display = 'block';

ย ย ย ย ย ย ย ย ย ย console.log(`Audio listo para previsualizar. URL: ${audioUrl}`);
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย audioChunks = []; // Limpia chunks para la prรณxima
ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // 3. Iniciar la GRABACIรN de audio
ย ย ย ย ย ย ย ย mediaRecorder.start();

ย ย ย ย ย ย ย ย // 4. Configurar e iniciar la TRANSCRIPCIรN
ย ย ย ย ย ย ย ย if (actaTextarea) {
ย ย ย ย ย ย ย ย ย ย finalTranscript = actaTextarea.value + '\n';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย recognition.start(); 

ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("Error al iniciar la grabaciรณn/transcripciรณn:", err);
ย ย ย ย ย ย ย ย sttStatus.textContent = "Error: No se pudo acceder al micrรณfono.";
ย ย ย ย ย ย ย ย if (micStream) {
ย ย ย ย ย ย ย ย ย ย micStream.getTracks().forEach(track => track.stop());
ย ย ย ย ย ย ย ย ย ย micStream = null;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }

ย ย // --- BOTรN DETENER (MODIFICADO) ---
ย ย if(btnStop) {
ย ย ย ย btnStop.addEventListener('click', () => {
ย ย ย ย ย ย // 1. Detener la transcripciรณn
ย ย ย ย ย ย if (recognition) {
ย ย ย ย ย ย ย ย recognition.stop();
ย ย ย ย ย ย }

ย ย ย ย ย ย // 2. Detener la grabaciรณn (esto dispararรก 'mediaRecorder.onstop' para el PREVIEW)
ย ย ย ย ย ย if (mediaRecorder && mediaRecorder.state === "recording") {
ย ย ย ย ย ย ย ย mediaRecorder.stop();
ย ย ย ย ย ย }

ย ย ย ย ย ย // 3. "Colgar" y liberar el micrรณfono
ย ย ย ย ย ย if (micStream) {
ย ย ย ย ย ย ย ย micStream.getTracks().forEach(track => track.stop());
ย ย ย ย ย ย ย ย micStream = null;
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }
});


// 2. Lรณgica de Envรญo de Email (INTACTA)
document.addEventListener('DOMContentLoaded', () => {
ย ย // ... (Tu cรณdigo de envรญo de email va aquรญ, no se toca) ...
ย ย // ... (Lo he omitido de esta respuesta por brevedad, pero
ย ย // ย ย ยen tu archivo debe quedar intacto) ...
ย ย const form = document.getElementById('formEnviarEmail');
ย ย if (!form) return;

ย ย const btnSubmit = document.getElementById('btnEnviarCorreo');
ย ย const btnTexto = document.getElementById('btnEnviarTexto');
ย ย const btnSpinner = document.getElementById('btnEnviarSpinner');
ย ย const chkAll = document.getElementById('chkTodosVecinos');
ย ย const lista = document.getElementById('lista-correos-vecinos');
ย ย const txtAdicionales = document.getElementById('correos_adicionales');
ย ย const msgErr = document.getElementById('email-error-msg');
ย ย const msgOk = document.getElementById('email-success-msg');

ย ย const setSend = (msg, isSuccess = false) => {
ย ย ย ย btnTexto.style.display = 'inline';
ย ย ย ย btnSpinner.style.display = 'none';
ย ย ย ย btnSubmit.disabled = false;
ย ย ย ย msgErr.style.display = 'none';
ย ย ย ย msgOk.style.display = 'none';
ย ย ย ย 
ย ย ย ย if (!msg) return;
ย ย ย ย 
ย ย ย ย const target = isSuccess ? msgOk : msgErr;
ย ย ย ย target.textContent = msg;
ย ย ย ย target.style.display = 'block';
ย ย }

ย ย // Checkbox "Todos"
ย ย if(chkAll && lista) {
ย ย ย ย chkAll.addEventListener('change', (e) => {
ย ย ย ย ย ย lista.querySelectorAll('.chk-email').forEach(cb => {
ย ย ย ย ย ย ย ย cb.checked = e.target.checked;
ย ย ย ย ย ย });
ย ย ย ย });
ย ย }

ย ย // Form submit
ย ย form.addEventListener('submit', async (e) => {
ย ย ย ย e.preventDefault();
ย ย ย ย btnSubmit.disabled = true;
ย ย ย ย btnTexto.style.display = 'none';
ย ย ย ย btnSpinner.style.display = 'inline';
ย ย ย ย 
ย ย ย ย let marcados = [];
ย ย ย ย if (lista) {
ย ย ย ย ย ย marcados = Array.from(lista.querySelectorAll('.chk-email:checked')).map(cb => cb.value);
ย ย ย ย }
ย ย ย ย 
ย ย ย ย let extras = [];
ย ย ย ย if (txtAdicionales) {
ย ย ย ย ย ย extras = txtAdicionales.value.split(',')
ย ย ย ย ย ย ย ย .map(e => e.trim())
ย ย ย ย ย ย ย ย .filter(Boolean);
ย ย ย ย }

ย ย ย ย const todos = [...new Set([...marcados, ...extras])];
ย ย ย ย if (!todos.length){
ย ย ย ย ย setSend('Selecciona al menos un correo (o escribe uno adicional).', false);
ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const fd = new FormData();
ย ย ย ย todos.forEach(c => fd.append('correos[]', c));

ย ย ย ย try {
ย ย ย ย ย const resp = await fetch("{% url 'reuniones:enviar_acta_pdf_por_correo' reunion.pk %}", {
ย ย ย ย ย ย method:'POST',
ย ย ย ย ย ย headers:{'X-CSRFToken': getCSRF()},
ย ย ย ย ย ย body: fd
ย ย ย ย ย });
ย ย ย ย ย 
ย ย ย ย ย if (!resp.ok){
ย ย ย ย ย ย const txt = await resp.text();
ย ย ย ย ย ย setSend('Error: ' + (txt || 'No se pudo enviar'), false);
ย ย ย ย ย ย return;
ย ย ย ย ย }
ย ย ย ย ย 
ย ย ย ย ย const data = await resp.json();
ย ย ย ย ย if (data.ok){
ย ย ย ย ย ย setSend('ยกActa enviada correctamente!', true);
ย ย ย ย ย ย setTimeout(()=> {
ย ย ย ย ย ย ย const modalEl = document.getElementById('modalEnviarActa');
ย ย ย ย ย ย ย if (modalEl && window.bootstrap){
ย ย ย ย ย ย ย ย const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
ย ย ย ย ย ย ย ย modal.hide();
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย setSend('');
ย ย ย ย ย ย ย form.reset();
ย ย ย ย ย ย ย if (lista) {
ย ย ย ย ย ย ย ย ย lista.querySelectorAll('.chk-email').forEach(cb => cb.checked = false);
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย if (chkAll) chkAll.checked = false;
ย ย ย ย ย ย }, 1200);
ย ย ย ย ย } else {
ย ย ย ย ย ย setSend(data.message || 'Error desconocido', false);
ย ย ย ย ย }
ย ย ย ย } catch(err) {
ย ย ย ย ย ย console.error('Fetch error:', err);
ย ย ย ย ย ย setSend('Error de red. Revisa la consola.', false);
ย ย ย ย }
ย ย });
});
// ===================================================
// --- PASO 4: PEGA ESTE NUEVO SCRIPT AQUร ---
// ===================================================
document.addEventListener('DOMContentLoaded', () => {
ย ย // 1. Busca el cuadro de alerta de "Pendiente" o "Procesando"
ย ย const barraEstado = document.getElementById('transcripcion-pendiente');

ย ย // Si la barra no existe (porque estรก "Completado" o "No Subido"), no hace nada.
ย ย if (!barraEstado) {
ย ย ย ย return;
ย ย }

ย ย // 2. Si existe, define la funciรณn que consulta el estado
ย ย const urlConsulta = "{% url 'reuniones:get_acta_estado' reunion.pk %}";
ย ย let pollInterval = null; // Variable para guardar el 'timer'

ย ย async function checkStatus() {
ย ย ย ย try {
ย ย ย ย ย ย const response = await fetch(urlConsulta);
ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย console.error("Error de red al consultar estado.");
ย ย ย ย ย ย ย ย clearInterval(pollInterval); // Detiene el polling si hay error
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย console.log("Consultando estado:", data.estado);

ย ย ย ย ย ย // 3. Revisa si el estado cambiรณ
ย ย ย ย ย ย if (data.estado === 'COMPLETADO' || data.estado === 'ERROR') {
ย ย ย ย ย ย ย ย console.log("ยกProceso terminado! Recargando pรกgina...");
ย ย ย ย ย ย ย ย clearInterval(pollInterval); // Detiene el polling
ย ย ย ย ย ย ย ย window.location.reload(); // ยกRecarga la pรกgina!
ย ย ย ย ย ย }
ย ย ย ย ย ย // Si sigue en 'PENDIENTE' o 'PROCESANDO', no hace nada y espera al siguiente ciclo.

ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error("Error en polling:", error);
ย ย ย ย ย ย clearInterval(pollInterval); // Detiene el polling si hay error
ย ย ย ย }
ย ย }

ย ย // 4. Inicia el "sondeo" cada 5 segundos (5000 ms)
ย ย pollInterval = setInterval(checkStatus, 5000);
});
// ===================================================
// --- FIN DEL NUEVO SCRIPT ---
// ===================================================
</script>
{% endblock %}